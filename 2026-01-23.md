å¤ªæ£’äº†ï¼ğŸ‰ ç¾åœ¨ä½ æœ‰äº†ä¸€å€‹å®Œæ•´çš„åŸºç¤æ¶æ§‹ï¼Œè®“æˆ‘å€‘ç¹¼çºŒæ·±å…¥å­¸ç¿’ã€‚

---

## ğŸ—ºï¸ ä½ å¯ä»¥å¾é€™å€‹å°ˆæ¡ˆå»¶ä¼¸å­¸ç¿’çš„æ–¹å‘

| ä¸»é¡Œ                     | é›£åº¦  | å­¸åˆ°ä»€éº¼                 |
| ---------------------- | --- | -------------------- |
| **SQL æŸ¥è©¢ç·´ç¿’**           | â­   | JOINã€èšåˆã€å­æŸ¥è©¢          |
| **RLS æ”¿ç­–é€²éš**           | â­â­  | æ›´è¤‡é›œçš„æ¬Šé™æ§åˆ¶             |
| **Database Functions** | â­â­  | ç”¨ SQL å¯«å•†æ¥­é‚è¼¯          |
| **Realtime è¨‚é–±**        | â­â­  | å³æ™‚è³‡æ–™åŒæ­¥               |
| **Storage æª”æ¡ˆç®¡ç†**       | â­â­  | ä¸Šå‚³é ­åƒã€é™„ä»¶              |
| **Edge Functions**     | â­â­â­ | ç”¨ TypeScript å¯«å¾Œç«¯ API |

---

æˆ‘å»ºè­°å…ˆå¾ **SQL æŸ¥è©¢** å’Œ **RLS é€²éš** é–‹å§‹ï¼Œé€™å…©å€‹æ˜¯ Supabase çš„æ ¸å¿ƒèƒ½åŠ›ã€‚

---

## ğŸ¯ ç¾åœ¨å°±ä¾†ç·´ç¿’ï¼šSQL æŸ¥è©¢

æ‰“é–‹ Studio çš„ **SQL Editor** (`http://localhost:54323`)ï¼Œè©¦è©¦é€™äº›æŸ¥è©¢ï¼š

### 1. åŸºæœ¬ JOIN â€” æŸ¥çœ‹èª°çš„å¾…è¾¦äº‹é …

```sql
select 
  p.username,
  p.full_name,
  t.title,
  t.is_completed,
  t.due_date
from public.todos t
join public.profiles p on t.user_id = p.id
order by t.due_date;
```

### 2. èšåˆçµ±è¨ˆ â€” æ¯å€‹ç”¨æˆ¶çš„å®Œæˆç‡

```sql
select 
  p.username,
  count(*) as total_todos,
  count(*) filter (where t.is_completed) as completed,
  round(
    100.0 * count(*) filter (where t.is_completed) / count(*), 
    1
  ) as completion_rate
from public.todos t
join public.profiles p on t.user_id = p.id
group by p.username;
```

### 3. æ¢ä»¶æŸ¥è©¢ â€” æ‰¾å‡ºé€¾æœŸæœªå®Œæˆçš„ä»»å‹™

```sql
select 
  p.username,
  t.title,
  t.due_date,
  current_date - t.due_date as days_overdue
from public.todos t
join public.profiles p on t.user_id = p.id
where t.is_completed = false 
  and t.due_date < current_date
order by days_overdue desc;
```

---

## ğŸ” RLS é€²éšç·´ç¿’

ç›®å‰çš„ RLS æ˜¯ã€Œç”¨æˆ¶åªèƒ½çœ‹è‡ªå·±çš„è³‡æ–™ã€ã€‚è®“æˆ‘å€‘åŠ ä¸€å€‹æ–°åŠŸèƒ½ï¼š**åˆ†äº«å¾…è¾¦äº‹é …çµ¦å…¶ä»–äºº**ã€‚

### Step 1ï¼šå»ºç«‹æ–° Migration

```bash
supabase migration new add_todo_sharing
```

### Step 2ï¼šè²¼ä¸Šä»¥ä¸‹ SQL

```sql
-- å»ºç«‹åˆ†äº«è¡¨
create table public.todo_shares (
  id bigint generated always as identity primary key,
  todo_id bigint references public.todos(id) on delete cascade,
  shared_with_user_id uuid references auth.users(id) on delete cascade,
  can_edit boolean default false,
  created_at timestamptz default now(),
  
  -- é˜²æ­¢é‡è¤‡åˆ†äº«
  unique(todo_id, shared_with_user_id)
);

-- å•Ÿç”¨ RLS
alter table public.todo_shares enable row level security;

-- åªæœ‰ todo æ“æœ‰è€…å¯ä»¥ç®¡ç†åˆ†äº«
create policy "Todo owners can manage shares"
  on public.todo_shares for all
  using (
    exists (
      select 1 from public.todos 
      where id = todo_id and user_id = auth.uid()
    )
  );

-- è¢«åˆ†äº«è€…å¯ä»¥çœ‹åˆ°åˆ†äº«è¨˜éŒ„
create policy "Shared users can view share record"
  on public.todo_shares for select
  using (shared_with_user_id = auth.uid());

-- ğŸ”‘ æ›´æ–° todos çš„ RLSï¼šåŠ å…¥ã€Œè¢«åˆ†äº«è€…ä¹Ÿèƒ½çœ‹ã€
drop policy if exists "Users can view own todos" on public.todos;

create policy "Users can view own or shared todos"
  on public.todos for select
  using (
    user_id = auth.uid()  -- è‡ªå·±çš„
    or 
    exists (  -- æˆ–è¢«åˆ†äº«çš„
      select 1 from public.todo_shares 
      where todo_id = id and shared_with_user_id = auth.uid()
    )
  );
```

### Step 3ï¼šæ›´æ–° seed.sql

åœ¨ `seed.sql` æœ€å¾ŒåŠ ä¸Šï¼š

```sql
-- Alice åˆ†äº«ä¸€å€‹ todo çµ¦ Bob
insert into public.todo_shares (todo_id, shared_with_user_id, can_edit)
select 
  t.id, 
  'a1b2c3d4-e5f6-7890-abcd-ef1234567890'::uuid,  -- Bob's ID
  false
from public.todos t
where t.title = 'ä¸²æ¥å‰ç«¯';
```

### Step 4ï¼šåŸ·è¡Œ

```bash
supabase db reset
```

### Step 5ï¼šé©—è­‰åˆ†äº«åŠŸèƒ½

```sql
-- æŸ¥çœ‹æ‰€æœ‰åˆ†äº«é—œä¿‚
select 
  p_owner.username as owner,
  t.title as todo,
  p_shared.username as shared_with,
  ts.can_edit
from public.todo_shares ts
join public.todos t on ts.todo_id = t.id
join public.profiles p_owner on t.user_id = p_owner.id
join public.profiles p_shared on ts.shared_with_user_id = p_shared.id;
```

---

## ğŸ“Š å­¸ç¿’é€²åº¦æ›´æ–°

| æŠ€èƒ½ | ç‹€æ…‹ |
|------|------|
| Migration & Seed | âœ… å·²å®Œæˆ |
| åŸºæœ¬ RLS | âœ… å·²å®Œæˆ |
| SQL JOIN & èšåˆ | ğŸ”„ ç·´ç¿’ä¸­ |
| RLS é€²éšï¼ˆå¤šæ¢ä»¶ï¼‰ | ğŸ”„ ç·´ç¿’ä¸­ |
| Database Functions | â³ ä¸‹ä¸€æ­¥ |
| Realtime | â³ å¾…è§£é– |

---

è©¦è©¦çœ‹é€™äº›æŸ¥è©¢å’Œæ–°çš„ sharing åŠŸèƒ½ï¼å®Œæˆå¾Œå‘Šè¨´æˆ‘ï¼Œæˆ‘å€‘å¯ä»¥ç¹¼çºŒå­¸ **Database Functions**ï¼ˆç”¨ SQL å¯« APIï¼‰æˆ– **Realtime**ï¼ˆå³æ™‚è¨‚é–±è³‡æ–™è®ŠåŒ–ï¼‰ğŸš€